## Introduction

The surveydatar package provides an integration with Flourish via flourishcharts, allowing you to convert cross-tabulation results into a selection of beautiful interactive charts. This vignette demonstrates how to create flourish visualizations from survey-style analysis using the familiar mtcars dataset.

## Setting Up Your Data

First, let's prepare the mtcars data for analysis:

```{r data-prep}
# Prepare mtcars data with car model names
mtcars2 <- mtcars %>%
mutate(model = row.names(mtcars), .before = mpg)
row.names(mtcars2) <- NULL
mtcars2$model <- as.factor(mtcars2$model)

# Create some categorical variables for better cross-tabulation
mtcars2 <- mtcars2 %>%
mutate(
  mpg_category = factor(ifelse(mpg >= 20, "High MPG (≥20)", "Low MPG (<20)")),
  cyl_category = factor(ifelse(cyl >= 6, "High Cylinders (≥6)", "Low Cylinders (<6)")),
  performance = factor(case_when(
    hp >= 200 ~ "High Performance",
    hp >= 100 ~ "Medium Performance",
    TRUE ~ "Low Performance"
  ))
)

head(mtcars2)
```

## Basic Flourish Integration

### Simple Cross-Tabulation

Start with a basic cross-tabulation and convert it to a Flourish chart:

```{r basic-flourish}
# Create a cross-tabulation
tab_result <- tab(mtcars2, cyl_category, mpg_category)

# Convert to Flourish format
fltab <- tab_to_flourish(tab_result)

# Preview the structure
print(fltab)
```

### Adding Custom Settings

Enhance your chart with custom Flourish settings:

```{r custom-settings}
# Create chart with custom styling
fltab_styled <- tab_to_flourish(
tab_result,
settings = list(
  "layout.title" = "Fuel Efficiency by Engine Size",
  "layout.subtitle" = "Analysis of mtcars dataset",
  "labels" = TRUE,
  "number_format.suffix" = "%",
  "number_format.n_dec" = 1
)
)

# Preview in browser (requires Flourish API key)
preview_flourish(fltab_styled)
```

### Using rows_list for Complex Groupings

Create more complicated analyses using tab's `rows_list()`:

```{r rows-list}
# Complex row groupings
tab_advanced <- tab(
mtcars2,
rows = rows_list(
  "All Cars" = cyl_category,
  "High Performance" = cyl_category * (hp >= 200),
  "Economy Focus" = cyl_category * (mpg >= 25)
),
cols = mpg_category
)

# Convert with appropriate chart type
fltab_advanced <- tab_to_flourish(
tab_advanced,
chart_type = "column_grouped",
settings = list(
  "layout.title" = "Car Categories by Performance and Efficiency"
)
)

preview_flourish(fltab_advanced)
```

### Mean Statistics for Numeric Analysis

Analyze continuous variables using mean statistics:

```{r mean-analysis}
# Average horsepower by categories
tab_hp_mean <- tab(
mtcars2,
performance,
cyl_category,
statistic = "mean",
values = "hp"
)

# Create chart optimized for mean values
fltab_hp <- tab_to_flourish(
tab_hp_mean,
chart_type = "column_grouped",
settings = list(
  "layout.title" = "Average Horsepower by Performance Category",
  "number_format.n_dec" = 0,
  "number_format.suffix" = " hp"
)
)

preview_flourish(fltab_hp)
```

### Time Series Style Analysis

Create line charts for time series data:

```{r line-chart}
# Add a year column to create time series data
mtcars2$year <- factor(sample(1973:1975, nrow(mtcars2), replace = TRUE))

# Create a tab showing average MPG over time by cylinder category
tab_line <- tab(mtcars2, cyl_category, year, statistic = "mean", values = "mpg")

fltab_line <- tab_to_flourish(
tab_line,
chart_type = "line",
settings = list(
  "layout.title" = "Fuel Efficiency Trends",
  "number_format.suffix" = " mpg"
)
)

preview_flourish(fltab_line)
```

#### Stacked Column Charts

Show composition within categories:

```{r stacked-column}
# Create percentage data for stacking
tab_stacked <- tab(mtcars2, performance, cyl_category, statistic = "column_pct")

fltab_stacked <- tab_to_flourish(
  tab_stacked,
  chart_type = "column_stacked",
  settings = list(
    "layout.title" = "Performance Distribution by Cylinder Category"
  )
)

preview_flourish(fltab_stacked)
```

#### Proportional Stacked Columns

Show 100% composition for comparison:

```{r stacked-column-prop}
fltab_stacked_prop <- tab_to_flourish(
  tab_stacked,
  chart_type = "column_stacked_prop",
  settings = list(
    "layout.title" = "Performance Distribution (Proportional)"
  )
)

preview_flourish(fltab_stacked_prop)
```

#### Stacked Bar Charts

Horizontal stacked bars for longer category labels:

```{r stacked-bar}
tab_bar <- tab(mtcars2, cyl_category, performance, statistic = "row_pct")

fltab_bar_stacked <- tab_to_flourish(
  tab_bar,
  chart_type = "bar_stacked",
  settings = list(
    "layout.title" = "Cylinder Distribution Across Performance Categories"
  )
)

preview_flourish(fltab_bar_stacked)
```

#### Proportional Stacked Bars

```{r stacked-bar-prop}
fltab_bar_stacked_prop <- tab_to_flourish(
  tab_bar,
  chart_type = "bar_stacked_prop",
  settings = list(
    "layout.title" = "Cylinder Distribution (Proportional)"
  )
)

preview_flourish(fltab_bar_stacked_prop)
```

#### Area Charts

Filled line charts for showing distributions across ordered categories:

```{r area-chart}
# Create ordered horsepower bins to show distribution
mtcars2$hp_range <- cut(mtcars2$hp, 
                         breaks = c(0, 100, 150, 200, 250, 350),
                         labels = c("50-100", "100-150", "150-200", "200-250", "250+"),
                         include.lowest = TRUE)

# Count of cars by cylinder category across HP ranges
tab_area <- tab(mtcars2, cyl_category, hp_range, statistic = "count")

fltab_area <- tab_to_flourish(
  tab_area,
  chart_type = "area",
  settings = list(
    "layout.title" = "Vehicle Distribution Across Horsepower Ranges"
  )
)

preview_flourish(fltab_area)
```

#### Stacked Area Charts

Show cumulative values across ordered categories:

```{r area-stacked}
# Use the same HP range to show cumulative distribution
tab_area_stacked <- tab(mtcars2, cyl_category, hp_range, statistic = "count")

fltab_area_stacked <- tab_to_flourish(
  tab_area_stacked,
  chart_type = "area_stacked",
  settings = list(
    "layout.title" = "Cumulative Vehicle Distribution by Engine Type"
  )
)

preview_flourish(fltab_area_stacked)
```

#### Donut Charts

Show proportions of a single categorical variable as a circular chart:

```{r donut}
# Single variable distribution
tab_donut <- tab(mtcars2, performance)

fltab_donut <- tab_to_flourish(
  tab_donut,
  chart_type = "donut",
  settings = list(
    "layout.title" = "Distribution of Performance Categories"
  )
)

preview_flourish(fltab_donut)
```

### Table View

Create beautiful, interactive tables for showing detailed survey data. Tables support advanced features like color coding, pagination, sorting, and search.

#### Preparing the Data

First, let's create detailed categorical variables suitable for tabular display:

```{r detailed-variables}
# Create detailed MPG categories
mtcars2$mpg_detailed <- cut(mtcars2$mpg, 
                             breaks = c(0, 15, 18, 21, 24, 27, 35), 
                             labels = c("Very Low (<15)", "Low (15-18)", 
                                       "Medium (18-21)", "Good (21-24)", 
                                       "Very Good (24-27)", "Excellent (27+)"))

# Create horsepower class categories
mtcars2$hp_class <- cut(mtcars2$hp, 
                         breaks = c(0, 100, 150, 200, 250, 350), 
                         labels = c("Economy (<100)", "Standard (100-150)", 
                                   "Performance (150-200)", "High Performance (200-250)", 
                                   "Extreme (250+)"))

# Preview the cross-tabulation
tab_detailed <- tab(mtcars2, mpg_detailed, hp_class)
tab_detailed
```

#### Basic Table Chart

Convert to a basic Flourish table with default settings:

```{r basic-table}
# Create a basic table chart
fltab_basic <- tab_to_flourish(
  tab_detailed,
  chart_type = "table"
)

# Preview (requires Flourish API key)
preview_flourish(fltab_basic)
```

#### Heatmap Color Coding

Add color coding to highlight patterns in your data:

```{r table-heatmap}
# Add heatmap coloring (each column scaled independently)
fltab_heatmap <- tab_to_flourish(
  tab_detailed,
  chart_type = "table",
  table_settings = list(
    color_mode = "heatmap",
    color_midpoint = "mean"
  )
)

preview_flourish(fltab_heatmap)
```

You can customize the color midpoint calculation:

```{r table-heatmap-median}
# Use median as midpoint instead of mean
fltab_heatmap_median <- tab_to_flourish(
  tab_detailed,
  chart_type = "table",
  table_settings = list(
    color_mode = "heatmap",
    color_midpoint = "median"
  )
)

preview_flourish(fltab_heatmap_median)
```

#### Custom Pagination and Search

Control how many rows appear per page and enable search functionality:

```{r table-pagination}
# Table with pagination and search
fltab_paginated <- tab_to_flourish(
  tab_detailed,
  chart_type = "table",
  table_settings = list(
    rows_per_page = 2,
    show_search = TRUE,
    show_sorting = TRUE
  )
)

preview_flourish(fltab_paginated)
```

#### Custom Color Palettes

Specify your own color palette for heatmaps:

```{r table-custom-colors}
# Custom brand colors
fltab_custom <- tab_to_flourish(
  tab_detailed,
  chart_type = "table",
  table_settings = list(
    color_mode = "heatmap",
    color_palette = c("#1f77b4", "#ffffff", "#ff7f0e"),  # Blue-White-Orange
    color_midpoint = 50  # Specific midpoint value
  )
)

preview_flourish(fltab_custom)
```

#### Combining Table Features

Combine multiple settings for a fully customized table:

```{r table-combined}
# Professional table with all features
fltab_professional <- tab_to_flourish(
  tab_detailed,
  chart_type = "table",
  table_settings = list(
    color_mode = "heatmap",
    color_midpoint = "mean",
    rows_per_page = 20,
    show_search = TRUE,
    show_sorting = TRUE,
    first_column_width = 2.0  # Make row labels extra wide
  ),
  settings = list(
    chart_layout_title = "Vehicle Distribution: Fuel Efficiency vs Engine Power",
    chart_layout_subtitle = "Based on mtcars dataset"
  )
)

preview_flourish(fltab_professional)
```

## Chart Type Selection

### Automatic Chart Type Detection

The package automatically selects appropriate chart types based on your data structure and statistic type. For count statistics, tables with many columns (>4) will use a table chart, while simpler structures use bar or column charts:

```{r auto-chart-types}
# Different data structures get different chart types

# 2x2 table → grouped columns
tab_2x2 <- tab(mtcars2, cyl_category, mpg_category)
fltab_2x2 <- tab_to_flourish(tab_2x2)
cat("2x2 table chart type:", fltab_2x2$chart_type, "\n")

# Single column → simple columns
tab_single <- tab(mtcars2, performance)
fltab_single <- tab_to_flourish(tab_single)
cat("Single column chart type:", fltab_single$chart_type, "\n")

# Many rows and columns → table
tab_detailed <- tab(mtcars2, mpg_detailed, hp_class)
fltab_detailed <- tab_to_flourish(tab_detailed)
cat("Large table chart type:", fltab_detailed$chart_type, "\n")
```

### Explicit Chart Type Control

Override automatic selection when needed:

```{r explicit-chart-types}
# Force different chart types
chart_types <- c("column_grouped", "bar_grouped", "donut", "table")

for (chart_type in chart_types) {
fltab <- tab_to_flourish(tab_result, chart_type = chart_type)
cat("Chart type:", chart_type, "- Data dimensions:",
    nrow(fltab$data), "x", ncol(fltab$data), "\n")
}
```

## Data Formatting Options

### Controlling Summary Rows and Columns

Customize which elements appear in your charts. Note that base counts are always removed for Flourish visualizations as they cannot be handled elegantly:

```{r formatting-options}
# Remove summary rows and columns for cleaner charts (default is TRUE)
fltab_clean <- tab_to_flourish(
tab_result,
strip_summary_rows = TRUE,
strip_summary_cols = TRUE
)

# Keep summary rows and columns for more detailed analysis
fltab_detailed <- tab_to_flourish(
tab_result,
strip_summary_rows = FALSE,
strip_summary_cols = FALSE
)
```

### Direct Flourish Manipulation

For advanced users, you can also manipulate Flourish objects directly:

```{r direct-flourish, eval=FALSE}
# Equivalent manual approach
library(flourishcharts)

f <- flourish(
  chart_type = fltab_final$chart_type,
  api_key = Sys.getenv("FLOURISH_API_KEY")
) %>%
  bind_line_bar_pie_data(
    data = fltab_final$data,
    label = fltab_final$bindings$label,
    value = fltab_final$bindings$value
  )

# Apply settings manually
f$x$state$layout$title <- "Vehicle Analysis: Efficiency vs Performance"
f$x$state$labels <- TRUE
f$x$state$number_format$suffix <- "%"

# Display
f
```

## Setup Requirements

To use the Flourish integration, you need:

1.  **Flourish API Key**: Sign up at [flourish.studio](https://flourish.studio) and get your API key
2.  **Environment Variable**: Set `FLOURISH_API_KEY` in your `.Renviron` file:

``` r
# Add to ~/.Renviron
FLOURISH_API_KEY=your_api_key_here
```

3.  **Required Packages**: Install `flourishcharts` and `tidyr`:

``` r
install.packages(c("flourishcharts", "tidyr"))
``